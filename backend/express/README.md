# lgmc-api

Logimic API

## rest-api

Contains YAML definition of the API.

## src

Contains implementation of the API based on Express.js. To run the API first copy `.env.example` to `.env` 
and update with values based on local environment.  
Run the app using `npm run dev` for version with hot reload or `npm start` for version without.
Files `src/routes.ts` and `src/swagger.json` are autogenerated and not committed (included in `.gitignore`). Running any of the previous start commands will generate them but IDE will probably display an error in `src/app.ts`. If you wish to generate them manually without running the application use `tsoa spec-and-routes` or `npm run build`.

### Requirements
Most of the dependencies can be installed using `npm install`. If you wish to use local databases you have to install both [PostgreSQL](https://www.postgresql.org/) and [InfluxDB](https://www.influxdata.com/).
You can easily run both using [docker](https://www.docker.com/). Run the following command:
```shell
docker run -p 8086:8086^
    -e DOCKER_INFLUXDB_INIT_MODE=setup^
    -e DOCKER_INFLUXDB_INIT_USERNAME=my-user^
    -e DOCKER_INFLUXDB_INIT_PASSWORD=my-password^
    -e DOCKER_INFLUXDB_INIT_ORG=my-org^
    -e DOCKER_INFLUXDB_INIT_BUCKET=my-bucket^
    influxdb:latest
``` 
to install `InfluxDB` and 
```shell
docker run --name postgres^
   -p 5432:5432^
   -e POSTGRES_PASSWORD=mysecretpassword^
   -d postgres
```
to install `PostreSQL`.  
Note: the `PostgreSQL` port has to be `5432`, the `InfluxDB` port has to match with the port provided in `.env` variable `INFLUX_URL=http://localhost:<port-number>`.
The `PostreSQL` database has to be seeded first. This can be done by creating a backup of a remote `PostgreSQL` database and restoring it locally.

### OpenAPI
OpenAPI / Swagger files are autogenerated from code using [tsoa](https://github.com/lukeautry/tsoa). The [selected version](https://github.com/lukeautry/tsoa#philosophy) of OpenAPI is version 3. This can be changed in the `tsoa.json/spec.specVersion`. Two routes are also defined for OpenAPI:
- `/api-docs/swagger.json` - Autogenerated OpenAPI definition
- `/api-docs/swagger/` - Local [Swagger UI](https://swagger.io/tools/swagger-ui/) using [swagger-ui-dist](https://github.com/swagger-api/swagger-ui)

Swagger UI is rather slow when parsing responses from the API, [Postman](https://www.postman.com/) works correctly. You can import the generated 
`swagger.json` located in `src` to import routes and test data to Postman.

#### tsoa basics
tsoa uses the combination of native TypeScript interfaces, decorators and javadoc for Swagger. Interfaces and decorators [describe the structure](https://tsoa-community.github.io/docs/getting-started.html#defining-our-first-model) of the API and the [javadoc](https://tsoa-community.github.io/docs/descriptions.html#endpoint-descriptions) is used for the documentation.
This package also automatically validates against used data types and generates errors, if needed. Example of a generated error:
```json
{
    "message": "Validation errors",
    "details": {
        "to": {
            "message": "invalid ISO 8601 datetime format, i.e. YYYY-MM-DDTHH:mm:ss",
            "value": "abcd"
        }
    }
}
```
For manual validation [express-validator](https://express-validator.github.io/docs/) can be used. Example of this is `src/validators/fromDateBeforeToDate.ts`. Throw any error and then use `src/middlewares/ExitValidator` middleware to automatically exit and convert the express-validator errors to tsoa format. 

### Dependency injection
[typedi](https://github.com/typestack/typedi) is currently used for dependency injection. 

### Testing
[Jest](https://jestjs.io/docs/getting-started) and [supertest](https://github.com/visionmedia/supertest) are currently used for testing. Run the test using the `jest` command.

### Code generation
It is possible to generate both the API and used type definitions for use in frontend. The process requires the `src/swagger.json` file. So far two packages had been tested.
First of these packages is [ng-openapi-gen](https://www.npmjs.com/package/ng-openapi-gen). This package generates both the type definitions an Angular artefacts and can be run using the `ng-openapi-gen --input src/swagger.json --output generated` command. This package requires OpenApi v3.
The second option is [openapi-typescript-codegen](https://github.com/ferdikoomen/openapi-typescript-codegen) and supports more generation options (native fetch, Angular, ...). This package supports both OpenApi v2 (Swagger) and OpenApi v3.
The generation flow can also be started by using the `npm run generate` target.
There is a submodule for generated artefacts that should be shared with frontend (`lgmc-api-artifacts`). You can also generate JSON schema from generated types located in `generated/models`. This can be done using the 
[typescript-json-schema](https://github.com/YousefED/typescript-json-schema) by using the `typescript-json-schema "generated/models/*.ts" "*" --defaultProps true --noExtraProps true --required true --id Api` and will generate the [draft-07](https://json-schema.org/draft-07/json-schema-release-notes.html) schema.

### Logging
Errors and requests are currently logged to Influx using the `src/middlewares/LoggingMiddleware.ts`. Target buckets can be set in `.env`. Make sure the access token has permissions to write to both buckets (and to create them if they don't exist).
The package [nax-ipware](https://github.com/neekware/fullerstack/blob/main/libs/nax-ipware/README.md) is currently used to make an attempt to get the client's IP.  
Express.js request is deeply nested so only selected fields are logged. This can be changed in the `getDataFromRequest` method of the `LoggingMiddleware`. 
